<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Workflow Dashboard</title>
  <style>
    :root {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2a2a2a;
      --bg-tertiary: #333;
      --text-primary: #fff;
      --text-secondary: #888;
      --accent: #4a9eff;
      --accent-hover: #6ab0ff;
      --success: #4caf50;
      --warning: #ff9800;
      --error: #f44336;
      --border: #444;
      --sidebar-width: 280px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }

    /* Layout */
    .app-layout {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-header h1 {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .sidebar-header p {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .sidebar-section {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-section-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }

    /* New Workflow Button */
    .new-workflow-btn {
      width: 100%;
      padding: 12px;
      font-size: 0.9rem;
      font-weight: 600;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .new-workflow-btn:hover {
      background: var(--accent-hover);
    }

    /* Workflow List */
    .workflow-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .workflow-item {
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 4px;
      transition: background 0.15s;
    }

    .workflow-item:hover {
      background: var(--bg-tertiary);
    }

    .workflow-item.active {
      background: var(--bg-tertiary);
      border: 1px solid var(--accent);
    }

    .workflow-item-title {
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .workflow-item-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.7rem;
      color: var(--text-secondary);
    }

    .workflow-status-badge {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.65rem;
      text-transform: uppercase;
      font-weight: 600;
    }

    .workflow-status-badge.created { background: var(--bg-tertiary); color: var(--text-secondary); }
    .workflow-status-badge.in_progress { background: rgba(74, 158, 255, 0.2); color: var(--accent); }
    .workflow-status-badge.paused { background: rgba(255, 152, 0, 0.2); color: var(--warning); }
    .workflow-status-badge.completed { background: rgba(76, 175, 80, 0.2); color: var(--success); }
    .workflow-status-badge.error { background: rgba(244, 67, 54, 0.2); color: var(--error); }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
    }

    /* Empty State */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state h2 {
      font-size: 1.2rem;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    /* Workflow Detail Header */
    .workflow-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    .workflow-header-info h2 {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .workflow-header-meta {
      display: flex;
      gap: 16px;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .workflow-header-actions {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 10px 16px;
      font-size: 0.85rem;
      font-weight: 500;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s, opacity 0.2s;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--accent-hover);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--border);
    }

    .btn-danger {
      background: rgba(244, 67, 54, 0.15);
      color: var(--error);
      border: 1px solid var(--error);
    }

    .btn-danger:hover:not(:disabled) {
      background: rgba(244, 67, 54, 0.25);
    }

    /* Steps Container */
    .steps-container {
      display: grid;
      gap: 16px;
    }

    /* Step Card */
    .step-card {
      background: var(--bg-secondary);
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .step-card.locked {
      opacity: 0.6;
    }

    .step-header {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      background: var(--bg-tertiary);
      cursor: pointer;
      user-select: none;
    }

    .step-number {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.9rem;
      margin-right: 16px;
      flex-shrink: 0;
    }

    .step-card[data-status="completed"] .step-number {
      background: var(--success);
    }

    .step-card[data-status="in_progress"] .step-number {
      background: var(--accent);
      animation: pulse 1.5s infinite;
    }

    .step-card[data-status="error"] .step-number {
      background: var(--error);
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(74, 158, 255, 0.4); }
      50% { box-shadow: 0 0 0 8px rgba(74, 158, 255, 0); }
    }

    .step-info {
      flex: 1;
    }

    .step-title {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 2px;
    }

    .step-description {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .step-status-badge {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.7rem;
      text-transform: uppercase;
      font-weight: 600;
      margin-left: 16px;
    }

    .step-status-badge.pending { background: var(--bg-secondary); color: var(--text-secondary); }
    .step-status-badge.in_progress { background: rgba(74, 158, 255, 0.2); color: var(--accent); }
    .step-status-badge.completed { background: rgba(76, 175, 80, 0.2); color: var(--success); }
    .step-status-badge.error { background: rgba(244, 67, 54, 0.2); color: var(--error); }
    .step-status-badge.skipped { background: var(--bg-secondary); color: var(--text-secondary); }

    .step-expand-icon {
      margin-left: 12px;
      color: var(--text-secondary);
      transition: transform 0.2s;
    }

    .step-card.expanded .step-expand-icon {
      transform: rotate(180deg);
    }

    .step-body {
      display: none;
      padding: 20px;
      border-top: 1px solid var(--border);
    }

    .step-card.expanded .step-body {
      display: block;
    }

    .step-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .step-output {
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 16px;
      font-size: 0.85rem;
    }

    .step-output-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }

    .step-output pre {
      white-space: pre-wrap;
      word-break: break-word;
      font-family: monospace;
      font-size: 0.8rem;
      color: var(--text-secondary);
      max-height: 300px;
      overflow-y: auto;
    }

    /* Output Preview Sections */
    .output-section {
      margin-top: 16px;
    }

    .output-section-title {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    /* Screenshot Grid */
    .screenshots-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
    }

    .screenshot-item {
      background: var(--bg-primary);
      border-radius: 8px;
      overflow: hidden;
    }

    .screenshot-item img {
      width: 100%;
      display: block;
      cursor: pointer;
    }

    .screenshot-item img:hover {
      opacity: 0.9;
    }

    .screenshot-info {
      padding: 8px;
      font-size: 0.75rem;
    }

    .screenshot-timestamp {
      color: var(--accent);
      font-family: monospace;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay[hidden] {
      display: none;
    }

    .modal {
      background: var(--bg-secondary);
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    .modal-header h3 {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 4px 8px;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .modal-body {
      padding: 20px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 6px;
      color: var(--text-secondary);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      font-size: 0.9rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      outline: none;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      border-color: var(--accent);
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      padding: 16px 20px;
      border-top: 1px solid var(--border);
    }

    /* Logs Panel */
    .logs-panel {
      margin-top: 24px;
      background: var(--bg-secondary);
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .logs-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }

    .logs-header h3 {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .logs-body {
      padding: 16px;
      max-height: 300px;
      overflow-y: auto;
    }

    .log-entry {
      display: flex;
      gap: 12px;
      padding: 8px 0;
      font-size: 0.8rem;
      border-bottom: 1px solid var(--border);
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    .log-time {
      color: var(--text-secondary);
      font-family: monospace;
      flex-shrink: 0;
    }

    .log-step {
      color: var(--accent);
      flex-shrink: 0;
      width: 60px;
    }

    .log-message {
      flex: 1;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .tab {
      padding: 12px 20px;
      font-size: 0.85rem;
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: color 0.2s, border-color 0.2s;
    }

    .tab:hover {
      color: var(--text-primary);
    }

    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    /* Utility */
    [hidden] {
      display: none !important;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .app-layout {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        max-height: 40vh;
      }

      .main-content {
        padding: 16px;
      }

      .workflow-header {
        flex-direction: column;
        gap: 16px;
      }

      .workflow-header-actions {
        width: 100%;
      }

      .workflow-header-actions .btn {
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>Video Workflow</h1>
        <p>Multi-step video processing</p>
      </div>

      <div class="sidebar-section">
        <button class="new-workflow-btn" onclick="showNewWorkflowModal()">
          + New Workflow
        </button>
      </div>

      <div class="sidebar-section-title" style="padding: 0 16px;">Workflows</div>
      <div class="workflow-list" id="workflow-list">
        <!-- Workflow items will be rendered here -->
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="main-content">
      <div class="empty-state" id="empty-state">
        <div class="empty-state-icon">&#127909;</div>
        <h2>No workflow selected</h2>
        <p>Create a new workflow or select one from the sidebar</p>
      </div>

      <!-- Workflow Detail View (hidden by default) -->
      <div id="workflow-detail" hidden>
        <div class="workflow-header">
          <div class="workflow-header-info">
            <h2 id="workflow-title">Workflow</h2>
            <div class="workflow-header-meta">
              <span id="workflow-source"></span>
              <span id="workflow-created"></span>
            </div>
          </div>
          <div class="workflow-header-actions">
            <button class="btn btn-secondary" onclick="refreshWorkflow()">Refresh</button>
            <button class="btn btn-danger" onclick="deleteCurrentWorkflow()">Delete</button>
          </div>
        </div>

        <!-- Steps -->
        <div class="steps-container" id="steps-container">
          <!-- Steps will be rendered here -->
        </div>

        <!-- Logs Panel -->
        <div class="logs-panel">
          <div class="logs-header">
            <h3>Activity Log</h3>
            <button class="btn btn-secondary" onclick="loadWorkflowLogs()" style="padding: 6px 12px; font-size: 0.75rem;">Refresh</button>
          </div>
          <div class="logs-body" id="logs-body">
            <div style="color: var(--text-secondary); font-size: 0.85rem;">No logs yet</div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- New Workflow Modal -->
  <div class="modal-overlay" id="new-workflow-modal" hidden>
    <div class="modal">
      <div class="modal-header">
        <h3>Create New Workflow</h3>
        <button class="modal-close" onclick="hideNewWorkflowModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="new-workflow-form" onsubmit="createNewWorkflow(event)">
          <div class="form-group">
            <label for="video-source">Video Source</label>
            <input type="text" id="video-source" placeholder="YouTube URL, direct link, or local path" required>
          </div>

          <details style="margin-bottom: 16px;">
            <summary style="cursor: pointer; color: var(--text-secondary); font-size: 0.85rem;">Advanced Options</summary>
            <div style="margin-top: 12px;">
              <div class="form-group">
                <label for="transcription-provider">Transcription Provider</label>
                <select id="transcription-provider">
                  <option value="whisper-local">Local Whisper</option>
                  <option value="groq">Groq (Fast)</option>
                  <option value="openai">OpenAI</option>
                </select>
              </div>
              <div class="form-group">
                <label for="max-keyframes">Max Key Frames</label>
                <input type="number" id="max-keyframes" placeholder="Auto (default: 20)" min="1" max="100">
              </div>
              <div class="form-group">
                <label for="language">Language</label>
                <input type="text" id="language" placeholder="Auto-detect" maxlength="5">
              </div>
            </div>
          </details>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" onclick="hideNewWorkflowModal()">Cancel</button>
        <button class="btn btn-primary" type="submit" form="new-workflow-form">Create Workflow</button>
      </div>
    </div>
  </div>

  <script>
    // ============ STATE ============
    const state = {
      workflows: [],
      currentWorkflowId: null,
      currentWorkflow: null,
      logs: [],
      pollingInterval: null
    };

    const POLL_INTERVAL = 3000;

    const STEPS = [
      { number: 1, name: 'Download Video', description: 'Download from YouTube or direct URL' },
      { number: 2, name: 'Transcribe', description: 'Extract audio and transcribe with Whisper' },
      { number: 3, name: 'Enhance', description: 'AI-enhance transcript and identify key frames' },
      { number: 4, name: 'Capture', description: 'Capture screenshots at key timestamps' },
      { number: 5, name: 'Save Transcript', description: 'Export transcript as markdown' },
      { number: 6, name: 'Generate Blog', description: 'AI-generate blog post with screenshots' },
      { number: 7, name: 'Generate Social', description: 'AI-generate social media posts' }
    ];

    const STEP_PREREQUISITES = {
      1: [],
      2: [1],
      3: [2],
      4: [3],
      5: [2],
      6: [3, 4],
      7: [3]
    };

    // ============ API ============
    async function api(url, options = {}) {
      const response = await fetch(url, {
        headers: { 'Content-Type': 'application/json' },
        ...options
      });

      if (!response.ok) {
        const error = await response.json().catch(() => ({ error: 'Request failed' }));
        throw new Error(error.error || `HTTP ${response.status}`);
      }

      if (response.status === 204) return null;
      return response.json();
    }

    async function fetchWorkflows() {
      const result = await api('/api/workflows?limit=50');
      return result.workflows || [];
    }

    async function fetchWorkflow(id) {
      return api(`/api/workflows/${id}`);
    }

    async function createWorkflow(data) {
      return api('/api/workflows', {
        method: 'POST',
        body: JSON.stringify(data)
      });
    }

    async function deleteWorkflow(id) {
      return api(`/api/workflows/${id}`, { method: 'DELETE' });
    }

    async function executeStep(workflowId, step, force = false) {
      return api(`/api/workflows/${workflowId}/steps/${step}/execute`, {
        method: 'POST',
        body: JSON.stringify({ force })
      });
    }

    async function fetchWorkflowLogs(workflowId, limit = 50) {
      const result = await api(`/api/workflows/${workflowId}/logs?limit=${limit}`);
      return result.logs || [];
    }

    // ============ RENDERING ============
    function renderWorkflowList() {
      const container = document.getElementById('workflow-list');

      if (state.workflows.length === 0) {
        container.innerHTML = `
          <div style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 0.85rem;">
            No workflows yet
          </div>
        `;
        return;
      }

      container.innerHTML = state.workflows.map(wf => `
        <div class="workflow-item ${wf.id === state.currentWorkflowId ? 'active' : ''}"
             onclick="selectWorkflow('${wf.id}')">
          <div class="workflow-item-title">${escapeHtml(wf.videoName || wf.videoSource || 'New Workflow')}</div>
          <div class="workflow-item-meta">
            <span>${formatDate(wf.createdAt)}</span>
            <span class="workflow-status-badge ${wf.status}">${wf.status.replace('_', ' ')}</span>
          </div>
        </div>
      `).join('');
    }

    function renderWorkflowDetail() {
      const wf = state.currentWorkflow;
      if (!wf) {
        document.getElementById('empty-state').hidden = false;
        document.getElementById('workflow-detail').hidden = true;
        return;
      }

      document.getElementById('empty-state').hidden = true;
      document.getElementById('workflow-detail').hidden = false;

      document.getElementById('workflow-title').textContent = wf.videoName || 'Processing...';
      document.getElementById('workflow-source').textContent = truncate(wf.videoSource, 50);
      document.getElementById('workflow-created').textContent = `Created ${formatDate(wf.createdAt)}`;

      renderSteps();
      renderLogs();
    }

    function renderSteps() {
      const wf = state.currentWorkflow;
      const container = document.getElementById('steps-container');

      container.innerHTML = STEPS.map(step => {
        const status = wf.stepStatuses[step.number] || 'pending';
        const prereqsMet = checkPrerequisites(wf, step.number);
        const isLocked = !prereqsMet && status === 'pending';
        const output = wf[`step${step.number}Output`];

        return `
          <div class="step-card ${isLocked ? 'locked' : ''}" data-step="${step.number}" data-status="${status}">
            <div class="step-header" onclick="toggleStep(${step.number})">
              <div class="step-number">${step.number}</div>
              <div class="step-info">
                <div class="step-title">${step.name}</div>
                <div class="step-description">${step.description}</div>
              </div>
              <span class="step-status-badge ${status}">${status.replace('_', ' ')}</span>
              <span class="step-expand-icon">&#9660;</span>
            </div>
            <div class="step-body">
              <div class="step-actions">
                ${renderStepActions(step.number, status, prereqsMet)}
              </div>
              ${output ? renderStepOutput(step.number, output) : '<div class="step-output"><div class="step-output-title">Output</div><p style="color: var(--text-secondary);">No output yet. Execute this step to generate output.</p></div>'}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderStepActions(stepNum, status, prereqsMet) {
      const canExecute = prereqsMet && status !== 'in_progress';
      const isCompleted = status === 'completed';

      let buttons = [];

      if (status === 'in_progress') {
        buttons.push(`<button class="btn btn-secondary" disabled>Executing...</button>`);
      } else if (canExecute) {
        buttons.push(`<button class="btn btn-primary" onclick="runStep(${stepNum}, false)">Execute Step</button>`);
        if (isCompleted) {
          buttons.push(`<button class="btn btn-secondary" onclick="runStep(${stepNum}, true)">Re-run</button>`);
        }
      } else {
        const missing = getMissingPrerequisites(state.currentWorkflow, stepNum);
        buttons.push(`<button class="btn btn-secondary" disabled>Requires step${missing.length > 1 ? 's' : ''} ${missing.join(', ')}</button>`);
      }

      return buttons.join('');
    }

    function renderStepOutput(stepNum, output) {
      let content = '';

      switch (stepNum) {
        case 1:
          content = `
            <p><strong>Video:</strong> ${escapeHtml(output.videoPath || '')}</p>
            <p><strong>Duration:</strong> ${formatDuration(output.duration)}</p>
            <p><strong>Size:</strong> ${formatFileSize(output.fileSize)}</p>
          `;
          break;

        case 2:
          content = `
            <p><strong>Transcript ID:</strong> ${escapeHtml(output.transcriptId || '')}</p>
            <p><strong>Segments:</strong> ${output.segments?.length || 0}</p>
            <p><strong>Provider:</strong> ${escapeHtml(output.provider || '')}</p>
          `;
          break;

        case 3:
          const keyFrames = output.keyFrames || [];
          content = `
            <p><strong>Key Frames:</strong> ${keyFrames.length}</p>
            <p><strong>Sections:</strong> ${output.sections?.length || 0}</p>
            ${keyFrames.length > 0 ? `
              <div style="margin-top: 12px;">
                <strong>Timestamps:</strong>
                <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">
                  ${keyFrames.slice(0, 10).map(kf => `<span style="background: var(--bg-primary); padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-family: monospace;">${formatTimestamp(kf.timestamp)}</span>`).join('')}
                  ${keyFrames.length > 10 ? `<span style="color: var(--text-secondary); font-size: 0.75rem;">+${keyFrames.length - 10} more</span>` : ''}
                </div>
              </div>
            ` : ''}
          `;
          break;

        case 4:
          const screenshots = output.screenshots || [];
          content = `
            <p><strong>Screenshots:</strong> ${screenshots.length}</p>
            ${output.galleryUrl ? `<p><a href="${output.galleryUrl}" target="_blank" style="color: var(--accent);">View Gallery</a></p>` : ''}
            ${screenshots.length > 0 ? `
              <div class="output-section">
                <div class="output-section-title">Captured Frames</div>
                <div class="screenshots-grid">
                  ${screenshots.slice(0, 8).map(s => `
                    <div class="screenshot-item">
                      <a href="${s.publicPath}" target="_blank">
                        <img src="${s.publicPath}" alt="Screenshot" loading="lazy">
                      </a>
                      <div class="screenshot-info">
                        <div class="screenshot-timestamp">${formatTimestamp(s.timestamp)}</div>
                      </div>
                    </div>
                  `).join('')}
                </div>
                ${screenshots.length > 8 ? `<p style="margin-top: 12px; color: var(--text-secondary); font-size: 0.8rem;">+${screenshots.length - 8} more screenshots</p>` : ''}
              </div>
            ` : ''}
          `;
          break;

        case 5:
          content = `
            <p><strong>Markdown Path:</strong> ${escapeHtml(output.markdownPath || '')}</p>
            ${output.publicPath ? `<p><a href="${output.publicPath}" target="_blank" style="color: var(--accent);">View Transcript</a></p>` : ''}
          `;
          break;

        case 6:
          content = `
            <p><strong>Blog Path:</strong> ${escapeHtml(output.blogPath || '')}</p>
            ${output.publicPath ? `<p><a href="${output.publicPath}" target="_blank" style="color: var(--accent);">View Blog Post</a></p>` : ''}
          `;
          break;

        case 7:
          const posts = output.posts || {};
          content = `
            <p><strong>Twitter Posts:</strong> ${posts.twitter?.length || 0}</p>
            <p><strong>LinkedIn:</strong> ${posts.linkedin ? 'Generated' : 'Not generated'}</p>
            <p><strong>Short Form:</strong> ${posts.shortForm?.length || 0}</p>
            ${output.publicPath ? `<p><a href="${output.publicPath}" target="_blank" style="color: var(--accent);">View Social Posts</a></p>` : ''}
          `;
          break;

        default:
          content = `<pre>${JSON.stringify(output, null, 2)}</pre>`;
      }

      return `
        <div class="step-output">
          <div class="step-output-title">Output</div>
          ${content}
        </div>
      `;
    }

    function renderLogs() {
      const container = document.getElementById('logs-body');

      if (state.logs.length === 0) {
        container.innerHTML = `<div style="color: var(--text-secondary); font-size: 0.85rem;">No logs yet</div>`;
        return;
      }

      container.innerHTML = state.logs.map(log => `
        <div class="log-entry">
          <span class="log-time">${formatTime(log.createdAt)}</span>
          <span class="log-step">Step ${log.step}</span>
          <span class="log-message">${escapeHtml(log.message)}</span>
        </div>
      `).join('');
    }

    // ============ ACTIONS ============
    async function loadWorkflows() {
      try {
        state.workflows = await fetchWorkflows();
        renderWorkflowList();
      } catch (error) {
        console.error('Failed to load workflows:', error);
      }
    }

    async function selectWorkflow(id) {
      state.currentWorkflowId = id;
      renderWorkflowList();

      try {
        state.currentWorkflow = await fetchWorkflow(id);
        state.logs = await fetchWorkflowLogs(id);
        renderWorkflowDetail();
        startPolling();
      } catch (error) {
        console.error('Failed to load workflow:', error);
        state.currentWorkflow = null;
        renderWorkflowDetail();
      }
    }

    async function refreshWorkflow() {
      if (!state.currentWorkflowId) return;

      try {
        state.currentWorkflow = await fetchWorkflow(state.currentWorkflowId);
        state.logs = await fetchWorkflowLogs(state.currentWorkflowId);
        renderWorkflowDetail();
      } catch (error) {
        console.error('Failed to refresh workflow:', error);
      }
    }

    async function loadWorkflowLogs() {
      if (!state.currentWorkflowId) return;

      try {
        state.logs = await fetchWorkflowLogs(state.currentWorkflowId);
        renderLogs();
      } catch (error) {
        console.error('Failed to load logs:', error);
      }
    }

    async function runStep(stepNum, force = false) {
      if (!state.currentWorkflowId) return;

      try {
        // Immediately update UI to show in_progress
        state.currentWorkflow.stepStatuses[stepNum] = 'in_progress';
        renderSteps();

        await executeStep(state.currentWorkflowId, stepNum, force);

        // Refresh to get updated data
        await refreshWorkflow();
        await loadWorkflows();
      } catch (error) {
        console.error('Failed to execute step:', error);
        alert(`Step execution failed: ${error.message}`);
        await refreshWorkflow();
      }
    }

    async function deleteCurrentWorkflow() {
      if (!state.currentWorkflowId) return;

      if (!confirm('Are you sure you want to delete this workflow?')) return;

      try {
        await deleteWorkflow(state.currentWorkflowId);
        state.currentWorkflowId = null;
        state.currentWorkflow = null;
        state.logs = [];
        stopPolling();
        await loadWorkflows();
        renderWorkflowDetail();
      } catch (error) {
        console.error('Failed to delete workflow:', error);
        alert(`Delete failed: ${error.message}`);
      }
    }

    async function createNewWorkflow(event) {
      event.preventDefault();

      const videoSource = document.getElementById('video-source').value.trim();
      if (!videoSource) return;

      const config = {};
      const provider = document.getElementById('transcription-provider').value;
      const maxKeyFrames = document.getElementById('max-keyframes').value;
      const language = document.getElementById('language').value.trim();

      if (provider) config.provider = provider;
      if (maxKeyFrames) config.maxKeyFrames = parseInt(maxKeyFrames, 10);
      if (language) config.language = language;

      try {
        const workflow = await createWorkflow({ videoSource, config });
        hideNewWorkflowModal();
        document.getElementById('new-workflow-form').reset();
        await loadWorkflows();
        await selectWorkflow(workflow.id);
      } catch (error) {
        console.error('Failed to create workflow:', error);
        alert(`Failed to create workflow: ${error.message}`);
      }
    }

    // ============ POLLING ============
    function startPolling() {
      stopPolling();

      if (!state.currentWorkflowId) return;

      state.pollingInterval = setInterval(async () => {
        if (!state.currentWorkflowId) {
          stopPolling();
          return;
        }

        const wf = state.currentWorkflow;
        if (wf && (wf.status === 'completed' || wf.status === 'error')) {
          // Still poll but less frequently for completed workflows
          return;
        }

        try {
          state.currentWorkflow = await fetchWorkflow(state.currentWorkflowId);
          state.logs = await fetchWorkflowLogs(state.currentWorkflowId);
          renderWorkflowDetail();
          await loadWorkflows();
        } catch (error) {
          console.error('Polling error:', error);
        }
      }, POLL_INTERVAL);
    }

    function stopPolling() {
      if (state.pollingInterval) {
        clearInterval(state.pollingInterval);
        state.pollingInterval = null;
      }
    }

    // ============ UI HELPERS ============
    function toggleStep(stepNum) {
      const card = document.querySelector(`.step-card[data-step="${stepNum}"]`);
      if (card) {
        card.classList.toggle('expanded');
      }
    }

    function showNewWorkflowModal() {
      document.getElementById('new-workflow-modal').hidden = false;
    }

    function hideNewWorkflowModal() {
      document.getElementById('new-workflow-modal').hidden = true;
    }

    function checkPrerequisites(wf, stepNum) {
      const prereqs = STEP_PREREQUISITES[stepNum] || [];
      return prereqs.every(prereq => wf.stepStatuses[prereq] === 'completed');
    }

    function getMissingPrerequisites(wf, stepNum) {
      const prereqs = STEP_PREREQUISITES[stepNum] || [];
      return prereqs.filter(prereq => wf.stepStatuses[prereq] !== 'completed');
    }

    // ============ UTILITIES ============
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    function truncate(str, maxLen) {
      if (!str) return '';
      if (str.length <= maxLen) return str;
      return str.substring(0, maxLen) + '...';
    }

    function formatDate(isoString) {
      if (!isoString) return '';
      try {
        const date = new Date(isoString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      } catch {
        return '';
      }
    }

    function formatTime(isoString) {
      if (!isoString) return '';
      try {
        return new Date(isoString).toLocaleTimeString();
      } catch {
        return '';
      }
    }

    function formatTimestamp(seconds) {
      if (typeof seconds !== 'number' || isNaN(seconds)) return '--:--';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function formatDuration(seconds) {
      if (!seconds) return '--';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      if (mins > 0) {
        return `${mins}m ${secs}s`;
      }
      return `${secs}s`;
    }

    function formatFileSize(bytes) {
      if (!bytes) return '--';
      if (bytes < 1024) return `${bytes} B`;
      if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
      if (bytes < 1024 * 1024 * 1024) return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
      return `${(bytes / (1024 * 1024 * 1024)).toFixed(2)} GB`;
    }

    // ============ INIT ============
    async function init() {
      await loadWorkflows();

      // Close modal on escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          hideNewWorkflowModal();
        }
      });

      // Close modal on overlay click
      document.getElementById('new-workflow-modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) {
          hideNewWorkflowModal();
        }
      });
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
